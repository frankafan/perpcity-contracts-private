# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.
# Table of Contents

- [Summary](#summary)
  - [Files Summary](#files-summary)
  - [Files Details](#files-details)
  - [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
  - [H-1: Contract Name Reused in Different Files](#h-1-contract-name-reused-in-different-files)
  - [H-2: Contract locks Ether without a withdraw function](#h-2-contract-locks-ether-without-a-withdraw-function)
- [Low Issues](#low-issues)
  - [L-1: Centralization Risk](#l-1-centralization-risk)
  - [L-2: Unspecific Solidity Pragma](#l-2-unspecific-solidity-pragma)
  - [L-3: Literal Instead of Constant](#l-3-literal-instead-of-constant)
  - [L-4: PUSH0 Opcode](#l-4-push0-opcode)
  - [L-5: Internal Function Used Only Once](#l-5-internal-function-used-only-once)
  - [L-6: Contract has TODO Comments](#l-6-contract-has-todo-comments)
  - [L-7: Loop Contains `require`/`revert`](#l-7-loop-contains-requirerevert)
  - [L-8: Costly operations inside loop](#l-8-costly-operations-inside-loop)
  - [L-9: Missing Inheritance](#l-9-missing-inheritance)
  - [L-10: State Change Without Event](#l-10-state-change-without-event)
  - [L-11: Unchecked Return](#l-11-unchecked-return)


# Summary

## Files Summary

| Key | Value |
| --- | --- |
| .sol Files | 28 |
| Total nSLOC | 2527 |


## Files Details

| Filepath | nSLOC |
| --- | --- |
| src/AccountingToken.sol | 25 |
| src/BeaconRegistry.sol | 23 |
| src/PerpManager.sol | 315 |
| src/PerpVault.sol | 7 |
| src/UnlockCallback.sol | 27 |
| src/interfaces/IBeacon.sol | 5 |
| src/interfaces/IPerpManager.sol | 144 |
| src/interfaces/ITWAPBeacon.sol | 5 |
| src/interfaces/IVerifier.sol | 4 |
| src/libraries/FixedPoint96.sol | 5 |
| src/libraries/Funding.sol | 61 |
| src/libraries/Hook.sol | 210 |
| src/libraries/LivePositionDetailsReverter.sol | 36 |
| src/libraries/MakerActions.sol | 237 |
| src/libraries/MoreSignedMath.sol | 21 |
| src/libraries/PerpLogic.sol | 182 |
| src/libraries/SharedPositionLogic.sol | 126 |
| src/libraries/TakerActions.sol | 122 |
| src/libraries/Tick.sol | 83 |
| src/libraries/TickTWAP.sol | 191 |
| src/libraries/TradingFee.sol | 66 |
| src/libraries/UintTWAP.sol | 177 |
| src/libraries/UniV4Broker.sol | 130 |
| src/libraries/UniswapV4Utility.sol | 234 |
| src/testnet/TestnetBeacon.sol | 56 |
| src/testnet/TestnetBeaconFactory.sol | 17 |
| src/testnet/TestnetUSDC.sol | 16 |
| src/utils/Constants.sol | 2 |
| **Total** | **2527** |


## Issue Summary

| Category | No. of Issues |
| --- | --- |
| High | 2 |
| Low | 11 |


# High Issues

## H-1: Contract Name Reused in Different Files

When compiling contracts with certain development frameworks (for example: Truffle), having contracts with the same name across different files can lead to one being overwritten.

<details><summary>1 Found Instances</summary>


- Found in src/libraries/FixedPoint96.sol [Line: 6](src/libraries/FixedPoint96.sol#L6)

	```solidity
	library FixedPoint96 {
	```

</details>



## H-2: Contract locks Ether without a withdraw function

It appears that the contract includes a payable function to accept Ether but lacks a corresponding function to withdraw it, which leads to the Ether being locked in the contract. To resolve this issue, please implement a public or external function that allows for the withdrawal of Ether from the contract.

<details><summary>2 Found Instances</summary>


- Found in src/BeaconRegistry.sol [Line: 7](src/BeaconRegistry.sol#L7)

	```solidity
	contract BeaconRegistry is Ownable {
	```

- Found in src/testnet/TestnetBeacon.sol [Line: 10](src/testnet/TestnetBeacon.sol#L10)

	```solidity
	contract TestnetBeacon is ITWAPBeacon, Ownable {
	```

</details>



# Low Issues

## L-1: Centralization Risk

Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

<details><summary>4 Found Instances</summary>


- Found in src/BeaconRegistry.sol [Line: 7](src/BeaconRegistry.sol#L7)

	```solidity
	contract BeaconRegistry is Ownable {
	```

- Found in src/BeaconRegistry.sol [Line: 28](src/BeaconRegistry.sol#L28)

	```solidity
	    function unregisterBeacon(address beacon) external onlyOwner {
	```

- Found in src/testnet/TestnetBeacon.sol [Line: 10](src/testnet/TestnetBeacon.sol#L10)

	```solidity
	contract TestnetBeacon is ITWAPBeacon, Ownable {
	```

- Found in src/testnet/TestnetBeacon.sol [Line: 42](src/testnet/TestnetBeacon.sol#L42)

	```solidity
	    function updateData(bytes calldata proof, bytes calldata publicSignals) external onlyOwner {
	```

</details>



## L-2: Unspecific Solidity Pragma

Consider using a specific version of Solidity in your contracts instead of a wide version. For example, instead of `pragma solidity ^0.8.0;`, use `pragma solidity 0.8.0;`

<details><summary>13 Found Instances</summary>


- Found in src/AccountingToken.sol [Line: 2](src/AccountingToken.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/BeaconRegistry.sol [Line: 2](src/BeaconRegistry.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/PerpManager.sol [Line: 2](src/PerpManager.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/PerpVault.sol [Line: 2](src/PerpVault.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/UnlockCallback.sol [Line: 2](src/UnlockCallback.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/interfaces/IBeacon.sol [Line: 2](src/interfaces/IBeacon.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/interfaces/IPerpManager.sol [Line: 2](src/interfaces/IPerpManager.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/interfaces/ITWAPBeacon.sol [Line: 2](src/interfaces/ITWAPBeacon.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/interfaces/IVerifier.sol [Line: 2](src/interfaces/IVerifier.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/testnet/TestnetBeacon.sol [Line: 2](src/testnet/TestnetBeacon.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/testnet/TestnetBeaconFactory.sol [Line: 2](src/testnet/TestnetBeaconFactory.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/testnet/TestnetUSDC.sol [Line: 2](src/testnet/TestnetUSDC.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/utils/Constants.sol [Line: 2](src/utils/Constants.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

</details>



## L-3: Literal Instead of Constant

Define and use `constant` variables instead of using literals. If the same constant literal value is used multiple times, create a constant state variable and reference it throughout the contract.

<details><summary>6 Found Instances</summary>


- Found in src/libraries/TickTWAP.sol [Line: 136](src/libraries/TickTWAP.sol#L136)

	```solidity
	        uint256 aAdjusted = a > time ? a : a + 2 ** 32;
	```

- Found in src/libraries/TickTWAP.sol [Line: 137](src/libraries/TickTWAP.sol#L137)

	```solidity
	        uint256 bAdjusted = b > time ? b : b + 2 ** 32;
	```

- Found in src/libraries/UintTWAP.sol [Line: 136](src/libraries/UintTWAP.sol#L136)

	```solidity
	        uint256 aAdjusted = a > time ? a : a + 2 ** 32;
	```

- Found in src/libraries/UintTWAP.sol [Line: 137](src/libraries/UintTWAP.sol#L137)

	```solidity
	        uint256 bAdjusted = b > time ? b : b + 2 ** 32;
	```

- Found in src/libraries/UniswapV4Utility.sol [Line: 147](src/libraries/UniswapV4Utility.sol#L147)

	```solidity
	        bytes[] memory params = new bytes[](3);
	```

- Found in src/libraries/UniswapV4Utility.sol [Line: 201](src/libraries/UniswapV4Utility.sol#L201)

	```solidity
	        bytes[] memory params = new bytes[](3);
	```

</details>



## L-4: PUSH0 Opcode

Solc compiler version 0.8.20 switches the default target EVM version to Shanghai, which means that the generated bytecode will include PUSH0 opcodes. Be sure to select the appropriate EVM version in case you intend to deploy on a chain other than mainnet like L2 chains that may not support PUSH0, otherwise deployment of your contracts will fail.

<details><summary>28 Found Instances</summary>


- Found in src/AccountingToken.sol [Line: 2](src/AccountingToken.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/BeaconRegistry.sol [Line: 2](src/BeaconRegistry.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/PerpManager.sol [Line: 2](src/PerpManager.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/PerpVault.sol [Line: 2](src/PerpVault.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/UnlockCallback.sol [Line: 2](src/UnlockCallback.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/interfaces/IBeacon.sol [Line: 2](src/interfaces/IBeacon.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/interfaces/IPerpManager.sol [Line: 2](src/interfaces/IPerpManager.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/interfaces/ITWAPBeacon.sol [Line: 2](src/interfaces/ITWAPBeacon.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/interfaces/IVerifier.sol [Line: 2](src/interfaces/IVerifier.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/libraries/FixedPoint96.sol [Line: 2](src/libraries/FixedPoint96.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/libraries/Funding.sol [Line: 2](src/libraries/Funding.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/libraries/Hook.sol [Line: 2](src/libraries/Hook.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/libraries/LivePositionDetailsReverter.sol [Line: 2](src/libraries/LivePositionDetailsReverter.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/libraries/MakerActions.sol [Line: 2](src/libraries/MakerActions.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/libraries/MoreSignedMath.sol [Line: 2](src/libraries/MoreSignedMath.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/libraries/PerpLogic.sol [Line: 2](src/libraries/PerpLogic.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/libraries/SharedPositionLogic.sol [Line: 2](src/libraries/SharedPositionLogic.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/libraries/TakerActions.sol [Line: 2](src/libraries/TakerActions.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/libraries/Tick.sol [Line: 2](src/libraries/Tick.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/libraries/TickTWAP.sol [Line: 2](src/libraries/TickTWAP.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/libraries/TradingFee.sol [Line: 2](src/libraries/TradingFee.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/libraries/UintTWAP.sol [Line: 2](src/libraries/UintTWAP.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/libraries/UniV4Broker.sol [Line: 2](src/libraries/UniV4Broker.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/libraries/UniswapV4Utility.sol [Line: 2](src/libraries/UniswapV4Utility.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/testnet/TestnetBeacon.sol [Line: 2](src/testnet/TestnetBeacon.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/testnet/TestnetBeaconFactory.sol [Line: 2](src/testnet/TestnetBeaconFactory.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/testnet/TestnetUSDC.sol [Line: 2](src/testnet/TestnetUSDC.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

- Found in src/utils/Constants.sol [Line: 2](src/utils/Constants.sol#L2)

	```solidity
	pragma solidity ^0.8.26;
	```

</details>



## L-5: Internal Function Used Only Once

Instead of separating the logic into a separate function, consider inlining the logic into the calling function. This can reduce the number of function calls and improve readability.

<details><summary>12 Found Instances</summary>


- Found in src/libraries/LivePositionDetailsReverter.sol [Line: 49](src/libraries/LivePositionDetailsReverter.sol#L49)

	```solidity
	    function parseSelector(bytes memory result) internal pure returns (bytes4 selector) {
	```

- Found in src/libraries/MakerActions.sol [Line: 202](src/libraries/MakerActions.sol#L202)

	```solidity
	    function makerFunding(
	```

- Found in src/libraries/MakerActions.sol [Line: 236](src/libraries/MakerActions.sol#L236)

	```solidity
	    function checkLockup(uint32 entryTimestamp, uint32 lockupPeriod) internal view {
	```

- Found in src/libraries/MakerActions.sol [Line: 243](src/libraries/MakerActions.sol#L243)

	```solidity
	    function settleExcess(
	```

- Found in src/libraries/PerpLogic.sol [Line: 83](src/libraries/PerpLogic.sol#L83)

	```solidity
	    function validateParams(IPerpManager.CreatePerpParams calldata params) internal pure {
	```

- Found in src/libraries/PerpLogic.sol [Line: 139](src/libraries/PerpLogic.sol#L139)

	```solidity
	    function createUniswapPool(
	```

- Found in src/libraries/PerpLogic.sol [Line: 208](src/libraries/PerpLogic.sol#L208)

	```solidity
	    function getTWAP(
	```

- Found in src/libraries/SharedPositionLogic.sol [Line: 98](src/libraries/SharedPositionLogic.sol#L98)

	```solidity
	    function isLiquidatable(
	```

- Found in src/libraries/SharedPositionLogic.sol [Line: 131](src/libraries/SharedPositionLogic.sol#L131)

	```solidity
	    function checkPriceImpact(
	```

- Found in src/libraries/TickTWAP.sol [Line: 251](src/libraries/TickTWAP.sol#L251)

	```solidity
	    function observeSingle(
	```

- Found in src/libraries/UintTWAP.sol [Line: 251](src/libraries/UintTWAP.sol#L251)

	```solidity
	    function observeSingle(
	```

- Found in src/libraries/UniswapV4Utility.sol [Line: 306](src/libraries/UniswapV4Utility.sol#L306)

	```solidity
	    function compress(int24 tick, int24 tickSpacing) internal pure returns (int24 compressed) {
	```

</details>



## L-6: Contract has TODO Comments

Contract contains comments with TODOS. Consider implementing or removing them.

<details><summary>1 Found Instances</summary>


- Found in src/libraries/PerpLogic.sol [Line: 22](src/libraries/PerpLogic.sol#L22)

	```solidity
	library PerpLogic {
	```

</details>



## L-7: Loop Contains `require`/`revert`

Avoid `require` / `revert` statements in a loop because a single bad item can cause the whole transaction to fail. It's better to forgive on fail and return failed elements post processing of the loop

<details><summary>5 Found Instances</summary>


- Found in src/PerpManager.sol [Line: 226](src/PerpManager.sol#L226)

	```solidity
	            while (tickUpper < tickBound) {
	```

- Found in src/PerpManager.sol [Line: 243](src/PerpManager.sol#L243)

	```solidity
	            while (tickUpper > tickBound) {
	```

- Found in src/libraries/Hook.sol [Line: 243](src/libraries/Hook.sol#L243)

	```solidity
	        do {
	```

- Found in src/libraries/TickTWAP.sol [Line: 316](src/libraries/TickTWAP.sol#L316)

	```solidity
	        for (uint256 i = 0; i < secondsAgos.length; i++) {
	```

- Found in src/libraries/UintTWAP.sol [Line: 316](src/libraries/UintTWAP.sol#L316)

	```solidity
	        for (uint256 i = 0; i < secondsAgos.length; i++) {
	```

</details>



## L-8: Costly operations inside loop

Invoking `SSTORE` operations in loops may waste gas. Use a local variable to hold the loop computation result.

<details><summary>3 Found Instances</summary>


- Found in src/libraries/Hook.sol [Line: 243](src/libraries/Hook.sol#L243)

	```solidity
	        do {
	```

- Found in src/libraries/TickTWAP.sol [Line: 120](src/libraries/TickTWAP.sol#L120)

	```solidity
	        for (uint32 i = current; i < next; i++) {
	```

- Found in src/libraries/UintTWAP.sol [Line: 120](src/libraries/UintTWAP.sol#L120)

	```solidity
	        for (uint32 i = current; i < next; i++) {
	```

</details>



## L-9: Missing Inheritance

There is an interface / abstract contract that is potentially missing (not included in) the inheritance of this contract.

<details><summary>1 Found Instances</summary>


- Found in src/UnlockCallback.sol [Line: 7](src/UnlockCallback.sol#L7)

	Is this contract supposed to implement an interface? Consider extending one of the following: IImmutableState
	```solidity
	contract UnlockCallback {
	```

</details>



## L-10: State Change Without Event

There are state variable changes in this function but no event is emitted. Consider emitting an event to enable offchain indexers to track the changes.

<details><summary>2 Found Instances</summary>


- Found in src/PerpManager.sol [Line: 112](src/PerpManager.sol#L112)

	```solidity
	    function increaseCardinalityNext(PoolId perpId, uint32 cardinalityNext) external {
	```

- Found in src/testnet/TestnetBeacon.sol [Line: 53](src/testnet/TestnetBeacon.sol#L53)

	```solidity
	    function increaseCardinalityNext(uint32 cardinalityNext)
	```

</details>



## L-11: Unchecked Return

Function returns a value but it is ignored. Consider checking the return value.

<details><summary>3 Found Instances</summary>


- Found in src/PerpManager.sol [Line: 113](src/PerpManager.sol#L113)

	```solidity
	        perps[perpId].increaseCardinalityNext(cardinalityNext);
	```

- Found in src/libraries/PerpLogic.sol [Line: 170](src/libraries/PerpLogic.sol#L170)

	```solidity
	        c.poolManager.initialize(poolKey, startingSqrtPriceX96);
	```

- Found in src/libraries/UniV4Broker.sol [Line: 80](src/libraries/UniV4Broker.sol#L80)

	```solidity
	        poolManager.initialize(poolKey, params.startingSqrtPriceX96);
	```

</details>



