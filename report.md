# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.
# Table of Contents

- [Summary](#summary)
  - [Files Summary](#files-summary)
  - [Files Details](#files-details)
  - [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
  - [H-1: Reentrancy: State change after external call](#h-1-reentrancy-state-change-after-external-call)
- [Low Issues](#low-issues)
  - [L-1: Large Numeric Literal](#l-1-large-numeric-literal)
  - [L-2: Internal Function Used Only Once](#l-2-internal-function-used-only-once)
  - [L-3: Contract has TODO Comments](#l-3-contract-has-todo-comments)
  - [L-4: Costly operations inside loop](#l-4-costly-operations-inside-loop)
  - [L-5: Unused Import](#l-5-unused-import)
  - [L-6: State Change Without Event](#l-6-state-change-without-event)
  - [L-7: Unchecked Return](#l-7-unchecked-return)


# Summary

## Files Summary

| Key | Value |
| --- | --- |
| .sol Files | 15 |
| Total nSLOC | 1308 |


## Files Details

| Filepath | nSLOC |
| --- | --- |
| src/AccountingToken.sol | 30 |
| src/PerpManager.sol | 127 |
| src/PerpVault.sol | 7 |
| src/UnlockCallback.sol | 31 |
| src/interfaces/IPerpManager.sol | 110 |
| src/interfaces/ITimeWeightedAvg.sol | 5 |
| src/libraries/Constants.sol | 23 |
| src/libraries/Funding.sol | 52 |
| src/libraries/PerpLogic.sol | 440 |
| src/libraries/QuoteReverter.sol | 33 |
| src/libraries/SignedMath.sol | 19 |
| src/libraries/Tick.sol | 96 |
| src/libraries/TimeWeightedAvg.sol | 122 |
| src/libraries/TradingFee.sol | 28 |
| src/libraries/UniV4Router.sol | 185 |
| **Total** | **1308** |


## Issue Summary

| Category | No. of Issues |
| --- | --- |
| High | 1 |
| Low | 7 |


# High Issues

## H-1: Reentrancy: State change after external call

Changing state after an external call can lead to re-entrancy attacks.Use the checks-effects-interactions pattern to avoid this issue.

<details><summary>3 Found Instances</summary>


- Found in src/AccountingToken.sol [Line: 38](src/AccountingToken.sol#L38)

	State is changed at: `isInitialized = true`
	```solidity
	        poolManager.sync(currency);
	```

- Found in src/AccountingToken.sol [Line: 44](src/AccountingToken.sol#L44)

	State is changed at: `isInitialized = true`
	```solidity
	        poolManager.mint(msg.sender, currency.toId(), amountToMint);
	```

- Found in src/AccountingToken.sol [Line: 47](src/AccountingToken.sol#L47)

	State is changed at: `isInitialized = true`
	```solidity
	        poolManager.settle();
	```

</details>



# Low Issues

## L-1: Large Numeric Literal

Large literal values multiples of 10000 can be replaced with scientific notation.Use `e` notation, for example: `1e18`, instead of its full numeric value.

<details><summary>1 Found Instances</summary>


- Found in src/libraries/TradingFee.sol [Line: 29](src/libraries/TradingFee.sol#L29)

	```solidity
	    uint24 constant DECAY = 15000000;
	```

</details>



## L-2: Internal Function Used Only Once

Instead of separating the logic into a separate function, consider inlining the logic into the calling function. This can reduce the number of function calls and improve readability.

<details><summary>2 Found Instances</summary>


- Found in src/libraries/PerpLogic.sol [Line: 460](src/libraries/PerpLogic.sol#L460)

	```solidity
	    function makerFunding(IPerpManager.Perp storage perp, IPerpManager.Position memory pos, int24 currentTick)
	```

- Found in src/libraries/UniV4Router.sol [Line: 330](src/libraries/UniV4Router.sol#L330)

	```solidity
	    function compress(int24 tick, int24 tickSpacing) internal pure returns (int24 compressed) {
	```

</details>



## L-3: Contract has TODO Comments

Contract contains comments with TODOS. Consider implementing or removing them.

<details><summary>4 Found Instances</summary>


- Found in src/PerpManager.sol [Line: 19](src/PerpManager.sol#L19)

	```solidity
	contract PerpManager is IPerpManager, UnlockCallback {
	```

- Found in src/UnlockCallback.sol [Line: 10](src/UnlockCallback.sol#L10)

	```solidity
	contract UnlockCallback is IUnlockCallback {
	```

- Found in src/libraries/PerpLogic.sol [Line: 27](src/libraries/PerpLogic.sol#L27)

	```solidity
	library PerpLogic {
	```

- Found in src/libraries/UniV4Router.sol [Line: 17](src/libraries/UniV4Router.sol#L17)

	```solidity
	library UniV4Router {
	```

</details>



## L-4: Costly operations inside loop

Invoking `SSTORE` operations in loops may waste gas. Use a local variable to hold the loop computation result.

<details><summary>1 Found Instances</summary>


- Found in src/libraries/TimeWeightedAvg.sol [Line: 62](src/libraries/TimeWeightedAvg.sol#L62)

	```solidity
	        for (uint16 i = state.cardinalityCap; i < newCap; i++) {
	```

</details>



## L-5: Unused Import

Redundant import statement. Consider removing it.

<details><summary>1 Found Instances</summary>


- Found in src/libraries/TradingFee.sol [Line: 6](src/libraries/TradingFee.sol#L6)

	```solidity
	import {INT_Q96, UINT_Q96} from "./Constants.sol";
	```

</details>



## L-6: State Change Without Event

There are state variable changes in this function but no event is emitted. Consider emitting an event to enable offchain indexers to track the changes.

<details><summary>2 Found Instances</summary>


- Found in src/AccountingToken.sol [Line: 30](src/AccountingToken.sol#L30)

	```solidity
	    function initialize(IPoolManager poolManager, uint256 amountToMint) external {
	```

- Found in src/PerpManager.sol [Line: 89](src/PerpManager.sol#L89)

	```solidity
	    function increaseCardinalityCap(PoolId perpId, uint16 cardinalityCap) external {
	```

</details>



## L-7: Unchecked Return

Function returns a value but it is ignored. Consider checking the return value.

<details><summary>4 Found Instances</summary>


- Found in src/AccountingToken.sol [Line: 47](src/AccountingToken.sol#L47)

	```solidity
	        poolManager.settle();
	```

- Found in src/libraries/PerpLogic.sol [Line: 231](src/libraries/PerpLogic.sol#L231)

	```solidity
	            poolManager.executeAction(
	```

- Found in src/libraries/PerpLogic.sol [Line: 275](src/libraries/PerpLogic.sol#L275)

	```solidity
	        updatePremiumPerSecond(perp, sqrtPriceX96);
	```

- Found in src/libraries/UniV4Router.sol [Line: 141](src/libraries/UniV4Router.sol#L141)

	```solidity
	        poolManager.initialize(poolKey, params.startingSqrtPriceX96);
	```

</details>



