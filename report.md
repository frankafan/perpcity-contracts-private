# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.
# Table of Contents

- [Summary](#summary)
  - [Files Summary](#files-summary)
  - [Files Details](#files-details)
  - [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
  - [H-1: Contract locks Ether without a withdraw function](#h-1-contract-locks-ether-without-a-withdraw-function)
  - [H-2: Reentrancy: State change after external call](#h-2-reentrancy-state-change-after-external-call)
- [Low Issues](#low-issues)
  - [L-1: Centralization Risk](#l-1-centralization-risk)
  - [L-2: Public Function Not Used Internally](#l-2-public-function-not-used-internally)
  - [L-3: Literal Instead of Constant](#l-3-literal-instead-of-constant)
  - [L-4: Large Numeric Literal](#l-4-large-numeric-literal)
  - [L-5: Internal Function Used Only Once](#l-5-internal-function-used-only-once)
  - [L-6: Contract has TODO Comments](#l-6-contract-has-todo-comments)
  - [L-7: Unused Error](#l-7-unused-error)
  - [L-8: Loop Contains `require`/`revert`](#l-8-loop-contains-requirerevert)
  - [L-9: Costly operations inside loop](#l-9-costly-operations-inside-loop)
  - [L-10: Unused Import](#l-10-unused-import)
  - [L-11: State Change Without Event](#l-11-state-change-without-event)
  - [L-12: Unchecked Return](#l-12-unchecked-return)


# Summary

## Files Summary

| Key | Value |
| --- | --- |
| .sol Files | 21 |
| Total nSLOC | 1561 |


## Files Details

| Filepath | nSLOC |
| --- | --- |
| src/AccountingToken.sol | 30 |
| src/BeaconRegistry.sol | 21 |
| src/PerpManager.sol | 100 |
| src/PerpVault.sol | 7 |
| src/UnlockCallback.sol | 27 |
| src/interfaces/IBeacon.sol | 5 |
| src/interfaces/IPerpManager.sol | 121 |
| src/interfaces/ITimeWeightedAvg.sol | 4 |
| src/interfaces/IVerifier.sol | 4 |
| src/libraries/Constants.sol | 26 |
| src/libraries/Funding.sol | 61 |
| src/libraries/LivePositionDetailsReverter.sol | 38 |
| src/libraries/MoreSignedMath.sol | 21 |
| src/libraries/PerpLogic.sol | 490 |
| src/libraries/Tick.sol | 106 |
| src/libraries/TimeWeightedAvg.sol | 175 |
| src/libraries/TradingFee.sol | 44 |
| src/libraries/UniV4Router.sol | 204 |
| src/testnet/TestnetBeacon.sol | 44 |
| src/testnet/TestnetBeaconFactory.sol | 17 |
| src/testnet/TestnetUSDC.sol | 16 |
| **Total** | **1561** |


## Issue Summary

| Category | No. of Issues |
| --- | --- |
| High | 2 |
| Low | 12 |


# High Issues

## H-1: Contract locks Ether without a withdraw function

It appears that the contract includes a payable function to accept Ether but lacks a corresponding function to withdraw it, which leads to the Ether being locked in the contract. To resolve this issue, please implement a public or external function that allows for the withdrawal of Ether from the contract.

<details><summary>2 Found Instances</summary>


- Found in src/BeaconRegistry.sol [Line: 7](src/BeaconRegistry.sol#L7)

	```solidity
	contract BeaconRegistry is Ownable {
	```

- Found in src/testnet/TestnetBeacon.sol [Line: 10](src/testnet/TestnetBeacon.sol#L10)

	```solidity
	contract TestnetBeacon is IBeacon, ITimeWeightedAvg, Ownable {
	```

</details>



## H-2: Reentrancy: State change after external call

Changing state after an external call can lead to re-entrancy attacks.Use the checks-effects-interactions pattern to avoid this issue.

<details><summary>3 Found Instances</summary>


- Found in src/AccountingToken.sol [Line: 23](src/AccountingToken.sol#L23)

	State is changed at: `isInitialized = true`
	```solidity
	        poolManager.sync(currency);
	```

- Found in src/AccountingToken.sol [Line: 29](src/AccountingToken.sol#L29)

	State is changed at: `isInitialized = true`
	```solidity
	        poolManager.mint(msg.sender, currency.toId(), amountToMint);
	```

- Found in src/AccountingToken.sol [Line: 32](src/AccountingToken.sol#L32)

	State is changed at: `isInitialized = true`
	```solidity
	        poolManager.settle();
	```

</details>



# Low Issues

## L-1: Centralization Risk

Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

<details><summary>5 Found Instances</summary>


- Found in src/BeaconRegistry.sol [Line: 7](src/BeaconRegistry.sol#L7)

	```solidity
	contract BeaconRegistry is Ownable {
	```

- Found in src/BeaconRegistry.sol [Line: 17](src/BeaconRegistry.sol#L17)

	```solidity
	    function registerBeacon(address beacon) external onlyOwner {
	```

- Found in src/BeaconRegistry.sol [Line: 24](src/BeaconRegistry.sol#L24)

	```solidity
	    function unregisterBeacon(address beacon) external onlyOwner {
	```

- Found in src/testnet/TestnetBeacon.sol [Line: 10](src/testnet/TestnetBeacon.sol#L10)

	```solidity
	contract TestnetBeacon is IBeacon, ITimeWeightedAvg, Ownable {
	```

- Found in src/testnet/TestnetBeacon.sol [Line: 38](src/testnet/TestnetBeacon.sol#L38)

	```solidity
	    function updateData(bytes calldata proof, bytes calldata publicSignals) external onlyOwner {
	```

</details>



## L-2: Public Function Not Used Internally

If a function is marked public but is not used internally, consider marking it as `external`.

<details><summary>2 Found Instances</summary>


- Found in src/AccountingToken.sol [Line: 15](src/AccountingToken.sol#L15)

	```solidity
	    function initialize(IPoolManager poolManager, uint256 amountToMint) public {
	```

- Found in src/PerpManager.sol [Line: 91](src/PerpManager.sol#L91)

	```solidity
	    function getTimeWeightedAvg(PoolId perpId, uint32 secondsAgo) public view returns (uint256) {
	```

</details>



## L-3: Literal Instead of Constant

Define and use `constant` variables instead of using literals. If the same constant literal value is used multiple times, create a constant state variable and reference it throughout the contract.

<details><summary>7 Found Instances</summary>


- Found in src/libraries/PerpLogic.sol [Line: 191](src/libraries/PerpLogic.sol#L191)

	```solidity
	        uint256 marginRatio = margin.fullMulDiv(1e6, notional);
	```

- Found in src/libraries/PerpLogic.sol [Line: 338](src/libraries/PerpLogic.sol#L338)

	```solidity
	        uint256 creatorFeeAmount = notional.mulDiv(perp.creatorFee, 1e6);
	```

- Found in src/libraries/PerpLogic.sol [Line: 340](src/libraries/PerpLogic.sol#L340)

	```solidity
	        uint256 insuranceFeeAmount = notional.mulDiv(perp.insuranceFee, 1e6);
	```

- Found in src/libraries/PerpLogic.sol [Line: 558](src/libraries/PerpLogic.sol#L558)

	```solidity
	        uint256 liquidationFeeAmt = notional.mulDiv(perp.liquidationFee, 1e6);
	```

- Found in src/libraries/PerpLogic.sol [Line: 566](src/libraries/PerpLogic.sol#L566)

	```solidity
	            uint256 marginRatioWithFee = (uint256(netMargin) - liquidationFeeAmt).mulDiv(1e6, notional);
	```

- Found in src/libraries/TimeWeightedAvg.sol [Line: 117](src/libraries/TimeWeightedAvg.sol#L117)

	```solidity
	        uint256 aAdjusted = a > time ? a : a + 2 ** 32;
	```

- Found in src/libraries/TimeWeightedAvg.sol [Line: 118](src/libraries/TimeWeightedAvg.sol#L118)

	```solidity
	        uint256 bAdjusted = b > time ? b : b + 2 ** 32;
	```

</details>



## L-4: Large Numeric Literal

Large literal values multiples of 10000 can be replaced with scientific notation.Use `e` notation, for example: `1e18`, instead of its full numeric value.

<details><summary>14 Found Instances</summary>


- Found in src/libraries/Constants.sol [Line: 13](src/libraries/Constants.sol#L13)

	```solidity
	uint24 constant PRICE_IMPACT_BAND = 100000; // 10%
	```

- Found in src/libraries/Constants.sol [Line: 14](src/libraries/Constants.sol#L14)

	```solidity
	uint24 constant MIN_OPENING_MARGIN = 1000000; // 1 USDC
	```

- Found in src/libraries/Constants.sol [Line: 15](src/libraries/Constants.sol#L15)

	```solidity
	uint24 constant MIN_MAKER_OPENING_MARGIN_RATIO = 1000000; // 100% / 1x leverage
	```

- Found in src/libraries/Constants.sol [Line: 16](src/libraries/Constants.sol#L16)

	```solidity
	uint24 constant MAX_MAKER_OPENING_MARGIN_RATIO = 4000000; // 400% / 0.25x leverage
	```

- Found in src/libraries/Constants.sol [Line: 17](src/libraries/Constants.sol#L17)

	```solidity
	uint24 constant MAKER_LIQUIDATION_MARGIN_RATIO = 500000; // 50% / 2x leverage
	```

- Found in src/libraries/Constants.sol [Line: 18](src/libraries/Constants.sol#L18)

	```solidity
	uint24 constant MIN_TAKER_OPENING_MARGIN_RATIO = 100000; // 10% / 10x leverage
	```

- Found in src/libraries/Constants.sol [Line: 19](src/libraries/Constants.sol#L19)

	```solidity
	uint24 constant MAX_TAKER_OPENING_MARGIN_RATIO = 2000000; // 200% / 0.5x leverage
	```

- Found in src/libraries/Constants.sol [Line: 20](src/libraries/Constants.sol#L20)

	```solidity
	uint24 constant TAKER_LIQUIDATION_MARGIN_RATIO = 50000; // 5% / 20x leverage
	```

- Found in src/libraries/Constants.sol [Line: 21](src/libraries/Constants.sol#L21)

	```solidity
	uint24 constant LIQUIDATION_FEE = 10000; // 1%
	```

- Found in src/libraries/Constants.sol [Line: 22](src/libraries/Constants.sol#L22)

	```solidity
	uint24 constant LIQUIDATOR_FEE_SPLIT = 500000; // 50%
	```

- Found in src/libraries/Constants.sol [Line: 23](src/libraries/Constants.sol#L23)

	```solidity
	uint24 constant START_FEE = 10000; // 1%
	```

- Found in src/libraries/Constants.sol [Line: 25](src/libraries/Constants.sol#L25)

	```solidity
	uint24 constant DECAY = 15000000;
	```

- Found in src/libraries/Constants.sol [Line: 26](src/libraries/Constants.sol#L26)

	```solidity
	uint24 constant VOLATILITY_SCALER = 200000; // 0.2
	```

- Found in src/libraries/Constants.sol [Line: 27](src/libraries/Constants.sol#L27)

	```solidity
	uint24 constant MAX_FEE_MULTIPLIER = 2000000;
	```

</details>



## L-5: Internal Function Used Only Once

Instead of separating the logic into a separate function, consider inlining the logic into the calling function. This can reduce the number of function calls and improve readability.

<details><summary>5 Found Instances</summary>


- Found in src/libraries/LivePositionDetailsReverter.sol [Line: 51](src/libraries/LivePositionDetailsReverter.sol#L51)

	```solidity
	    function parseSelector(bytes memory result) internal pure returns (bytes4 selector) {
	```

- Found in src/libraries/PerpLogic.sol [Line: 410](src/libraries/PerpLogic.sol#L410)

	```solidity
	    function makerFunding(
	```

- Found in src/libraries/PerpLogic.sol [Line: 647](src/libraries/PerpLogic.sol#L647)

	```solidity
	    function getTimeWeightedAvg(
	```

- Found in src/libraries/TimeWeightedAvg.sol [Line: 232](src/libraries/TimeWeightedAvg.sol#L232)

	```solidity
	    function observeSingle(
	```

- Found in src/libraries/UniV4Router.sol [Line: 275](src/libraries/UniV4Router.sol#L275)

	```solidity
	    function compress(int24 tick, int24 tickSpacing) internal pure returns (int24 compressed) {
	```

</details>



## L-6: Contract has TODO Comments

Contract contains comments with TODOS. Consider implementing or removing them.

<details><summary>1 Found Instances</summary>


- Found in src/interfaces/IPerpManager.sol [Line: 10](src/interfaces/IPerpManager.sol#L10)

	```solidity
	interface IPerpManager {
	```

</details>



## L-7: Unused Error

Consider using or removing the unused error.

<details><summary>14 Found Instances</summary>


- Found in src/interfaces/IPerpManager.sol [Line: 116](src/interfaces/IPerpManager.sol#L116)

	```solidity
	    error InvalidBeaconAddress(address beacon);
	```

- Found in src/interfaces/IPerpManager.sol [Line: 117](src/interfaces/IPerpManager.sol#L117)

	```solidity
	    error InvalidTradingFeeSplits(uint256 tradingFeeInsuranceSplitX96, uint256 tradingFeeCreatorSplitX96);
	```

- Found in src/interfaces/IPerpManager.sol [Line: 118](src/interfaces/IPerpManager.sol#L118)

	```solidity
	    error InvalidMaxOpeningLev(uint128 maxOpeningLevX96);
	```

- Found in src/interfaces/IPerpManager.sol [Line: 119](src/interfaces/IPerpManager.sol#L119)

	```solidity
	    error InvalidLiquidationLev(uint128 liquidationLevX96, uint128 maxOpeningLevX96);
	```

- Found in src/interfaces/IPerpManager.sol [Line: 120](src/interfaces/IPerpManager.sol#L120)

	```solidity
	    error InvalidLiquidationFee(uint128 liquidationFeeX96);
	```

- Found in src/interfaces/IPerpManager.sol [Line: 121](src/interfaces/IPerpManager.sol#L121)

	```solidity
	    error InvalidLiquidatorFeeSplit(uint128 liquidatorFeeSplitX96);
	```

- Found in src/interfaces/IPerpManager.sol [Line: 125](src/interfaces/IPerpManager.sol#L125)

	```solidity
	    error InvalidLevX96(uint256 levX96, uint128 maxOpeningLevX96);
	```

- Found in src/interfaces/IPerpManager.sol [Line: 128](src/interfaces/IPerpManager.sol#L128)

	```solidity
	    error InvalidPeriphery(address periphery, address expectedRouter, address expectedPositionManager);
	```

- Found in src/interfaces/IPerpManager.sol [Line: 129](src/interfaces/IPerpManager.sol#L129)

	```solidity
	    error PriceImpactTooHigh(uint256 priceX96, uint256 minPriceX96, uint256 maxPriceX96);
	```

- Found in src/interfaces/IPerpManager.sol [Line: 130](src/interfaces/IPerpManager.sol#L130)

	```solidity
	    error InvalidFundingInterval(uint32 fundingInterval);
	```

- Found in src/interfaces/IPerpManager.sol [Line: 131](src/interfaces/IPerpManager.sol#L131)

	```solidity
	    error InvalidPriceImpactBand(uint128 priceImpactBandX96);
	```

- Found in src/interfaces/IPerpManager.sol [Line: 132](src/interfaces/IPerpManager.sol#L132)

	```solidity
	    error InvalidTickRange(int24 tickLower, int24 tickUpper);
	```

- Found in src/interfaces/IPerpManager.sol [Line: 133](src/interfaces/IPerpManager.sol#L133)

	```solidity
	    error InvalidTradingFeeConfig(TradingFee.Config tradingFeeConfig);
	```

- Found in src/interfaces/IPerpManager.sol [Line: 134](src/interfaces/IPerpManager.sol#L134)

	```solidity
	    error InvalidStartingSqrtPriceX96(uint160 startingSqrtPriceX96);
	```

</details>



## L-8: Loop Contains `require`/`revert`

Avoid `require` / `revert` statements in a loop because a single bad item can cause the whole transaction to fail. It's better to forgive on fail and return failed elements post processing of the loop

<details><summary>1 Found Instances</summary>


- Found in src/libraries/TimeWeightedAvg.sol [Line: 297](src/libraries/TimeWeightedAvg.sol#L297)

	```solidity
	        for (uint256 i = 0; i < secondsAgos.length; i++) {
	```

</details>



## L-9: Costly operations inside loop

Invoking `SSTORE` operations in loops may waste gas. Use a local variable to hold the loop computation result.

<details><summary>1 Found Instances</summary>


- Found in src/libraries/TimeWeightedAvg.sol [Line: 101](src/libraries/TimeWeightedAvg.sol#L101)

	```solidity
	        for (uint32 i = current; i < next; i++) {
	```

</details>



## L-10: Unused Import

Redundant import statement. Consider removing it.

<details><summary>2 Found Instances</summary>


- Found in src/libraries/PerpLogic.sol [Line: 9](src/libraries/PerpLogic.sol#L9)

	```solidity
	import {Funding} from "./Funding.sol";
	```

- Found in src/libraries/PerpLogic.sol [Line: 10](src/libraries/PerpLogic.sol#L10)

	```solidity
	import {LivePositionDetailsReverter} from "./LivePositionDetailsReverter.sol";
	```

</details>



## L-11: State Change Without Event

There are state variable changes in this function but no event is emitted. Consider emitting an event to enable offchain indexers to track the changes.

<details><summary>3 Found Instances</summary>


- Found in src/AccountingToken.sol [Line: 15](src/AccountingToken.sol#L15)

	```solidity
	    function initialize(IPoolManager poolManager, uint256 amountToMint) public {
	```

- Found in src/PerpManager.sol [Line: 83](src/PerpManager.sol#L83)

	```solidity
	    function increaseCardinalityNext(PoolId perpId, uint32 cardinalityNext) external {
	```

- Found in src/testnet/TestnetBeacon.sol [Line: 46](src/testnet/TestnetBeacon.sol#L46)

	```solidity
	    function increaseCardinalityNext(uint32 cardinalityNext) external {
	```

</details>



## L-12: Unchecked Return

Function returns a value but it is ignored. Consider checking the return value.

<details><summary>2 Found Instances</summary>


- Found in src/AccountingToken.sol [Line: 32](src/AccountingToken.sol#L32)

	```solidity
	        poolManager.settle();
	```

- Found in src/libraries/UniV4Router.sol [Line: 99](src/libraries/UniV4Router.sol#L99)

	```solidity
	        poolManager.initialize(poolKey, params.startingSqrtPriceX96);
	```

</details>



